<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riwayat Chat - FisioKita</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-[#f8fafc] text-[#1E2A44] min-h-screen flex flex-col font-['Inter']">

<!-- Header -->
<header class="bg-gradient-to-r from-[#7F3CE0] to-[#4B6CC1] text-white px-6 py-4 flex justify-between items-center shadow">
  <h1 class="text-lg font-semibold">ğŸ“ Riwayat Konsultasi</h1>
  <a href="dashboard.html" class="text-sm underline hover:text-gray-200">Kembali</a>
</header>

<!-- Main -->
<main class="flex-1 max-w-md w-full mx-auto px-4 py-6 space-y-6">

  <!-- Daftar Riwayat -->
  <section>
    <h2 class="font-semibold text-base mb-2">ğŸ‘¥ Sesi Selesai</h2>
    <ul id="daftarRiwayat" class="space-y-2 text-sm"></ul>
  </section>

  <!-- Chat Box -->
  <section id="chatContainer" class="hidden space-y-2">
    <div id="chatBox" class="bg-white rounded-xl p-4 h-64 overflow-y-auto shadow-inner border space-y-2 text-sm"></div>
  </section>

  <!-- Footer -->
<footer class="bg-[#141C2F] text-white text-base mt-12">
  <div class="max-w-md mx-auto px-6 py-10 space-y-8">
    <div class="flex items-center gap-3">
      <img src="../img/logo.png" alt="Logo Fisio Kita" class="w-6 h-6" />
      <span class="font-bold text-2xl">Fisio Kita</span>
    </div>
    <p class="text-white/90 leading-relaxed">
      Kelola jadwal kerja harian Anda dengan mudah dan fleksibel.
    </p>

    <div>
      <h3 class="font-semibold text-lg mb-4">Navigasi</h3>
      <div class="grid grid-cols-2 gap-3">
        <a href="../index.html" class="nav-footer-btn">ğŸ  Beranda</a>
        <a href="dashboard.html" class="nav-footer-btn">ğŸ’¼ Dashboard</a>
        <a href="chat-aktif.html" class="nav-footer-btn">ğŸ’¬ Chat</a>
        <a href="pengaturan.html" class="nav-footer-btn">âš™ï¸ Pengaturan</a>
      </div>
    </div>

    <div>
      <h3 class="font-semibold text-lg mb-4">Kontak Admin</h3>
      <ul class="text-white/90 space-y-1 text-sm">
        <li>ğŸ“ <a href="https://wa.me/6285179792319">0851-7979-2319</a></li>
        <li>ğŸ“§ <a href="mailto:fisiokita.cs@gmail.com">fisiokita.cs@gmail.com</a></li>
      </ul>
    </div>

    <p class="text-center text-sm text-white/50 pt-6">
      Â© 2025 FisioKita. Semua hak dilindungi undang-undang.
    </p>
  </div>
</footer>

</main>

<!-- Firebase & Logic -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDng3ugBylPgzuxZA1YRPavo5br5jjlodo",
    authDomain: "fisiosehat-af9f1.firebaseapp.com",
    projectId: "fisiosehat-af9f1",
    storageBucket: "fisiosehat-af9f1.appspot.com",
    messagingSenderId: "800971487968",
    appId: "1:800971487968:web:0dec5977632004aa0fee85"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const daftarRiwayat = document.getElementById("daftarRiwayat");
  const chatBox = document.getElementById("chatBox");
  const chatContainer = document.getElementById("chatContainer");

  let currentEmail = "";

  auth.onAuthStateChanged(user => {
    if (user) {
      currentEmail = user.email;
      tampilkanRiwayat();
    } else {
      window.location.href = "login.html";
    }
  });

  function tampilkanRiwayat() {
    db.collection("sessions")
      .where("selesai", "==", true)
      .where("kepada", "==", currentEmail)
      .orderBy("dibuat", "desc")
      .onSnapshot(snapshot => {
        daftarRiwayat.innerHTML = "";

        if (snapshot.empty) {
          daftarRiwayat.innerHTML = `<li class="text-gray-500 italic">Belum ada riwayat konsultasi selesai.</li>`;
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("li");
          item.className = "bg-white p-3 rounded-xl border border-gray-200 shadow cursor-pointer hover:bg-[#DBEAFE] transition";
          item.innerHTML = `
            <div class="font-semibold">${data.namaPasien || "Pasien"}</div>
            <div class="text-xs text-gray-500">${doc.id}</div>
          `;
          item.addEventListener("click", () => bukaRiwayat(doc.id));
          daftarRiwayat.appendChild(item);
        });
      });
  }

  function bukaRiwayat(sessionId) {
    chatContainer.classList.remove("hidden");
    chatBox.innerHTML = "";

    db.collection("chats")
      .where("sessionId", "==", sessionId)
      .orderBy("waktu", "asc")
      .onSnapshot(snapshot => {
        chatBox.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const waktu = data.waktu?.toDate();
          const jam = waktu?.getHours().toString().padStart(2, "0");
          const menit = waktu?.getMinutes().toString().padStart(2, "0");
          const isAdmin = data.dari === "Admin";

          const bubble = document.createElement("div");
          if (isAdmin) {
            bubble.className = "flex justify-end";
            bubble.innerHTML = `
              <div class="bg-white text-black text-sm rounded-xl rounded-br-none px-3 py-2 shadow">
                ${data.pesan}
                <span class="text-xs text-gray-500 ml-2">${jam}.${menit}</span>
              </div>`;
          } else {
            bubble.className = "flex justify-start";
            bubble.innerHTML = `
              <div class="bg-[#DBEAFE] text-black text-sm rounded-xl rounded-tl-none px-3 py-2 shadow">
                ${data.pesan}
                <span class="text-xs text-gray-600 ml-2">${jam}.${menit}</span>
              </div>`;
          }
          chatBox.appendChild(bubble);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }
</script>
</body>
</html>
